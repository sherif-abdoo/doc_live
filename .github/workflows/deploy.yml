name: Deploy Backend

on:
  push:
    branches: [ "main" ]   # <-- change to "master" if your default branch is master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for completeness)
        uses: actions/checkout@v4

      - name: Setup Node (optional)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION || '20' }}

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.BACKEND_PATH }}
            # ensure repo exists and is clean
            git fetch --all
            git reset --hard origin/main   # change to origin/master if needed
            # install deps (prod only)
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi
            # run DB migrations if you use them (uncomment one)
            # npx sequelize db:migrate || true
            # npx prisma migrate deploy || true
            # restart app
            pm2 restart backend || pm2 start "npm start" --name backend
            pm2 save
